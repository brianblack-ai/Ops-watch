name: Uptime-check

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # hourly (UTC)

jobs:
  ping:
    runs-on: ubuntu-latest
    env:
      HEALTH_URL: "https://lead-engine-lilac.vercel.app/api/health"
      LATENCY_WARN_MS: "1200"  # alert on success if slower than this
    steps:
      - name: Ping health
        id: curl
        run: |
          set -e
          start_ms=$(date +%s%3N)
          code=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL")
          end_ms=$(date +%s%3N)
          ms=$((end_ms - start_ms))
          echo "code=$code" >> "$GITHUB_OUTPUT"
          echo "ms=$ms" >> "$GITHUB_OUTPUT"
          if [ "$code" -lt 200 ] || [ "$code" -ge 300 ]; then
            exit 1
          fi

      - name: Notify Slack ONLY on failure or slow success
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          STATUS: ${{ job.status }}
          CODE: ${{ steps.curl.outputs.code }}
          MS: ${{ steps.curl.outputs.ms }}
          HEALTH_URL: ${{ env.HEALTH_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          LAT_WARN: ${{ env.LATENCY_WARN_MS }}
        run: |
          send=false
          level="OK"
          if [ "$STATUS" != "success" ]; then
            send=true; level="FAIL"
          elif [ "$MS" -gt "$LAT_WARN" ]; then
            send=true; level="WARN"
          fi

          if $send; then
            # Ensure jq exists (usually preinstalled on ubuntu-latest)
            if ! command -v jq >/dev/null 2>&1; then
              sudo apt-get update -y && sudo apt-get install -y jq
            fi
            text="Uptime-check • ${level} • health (${HEALTH_URL}) • code=${CODE} • ${MS}ms • ${RUN_URL}"
            payload=$(jq -n --arg text "$text" '{text: $text}')
            curl -s -X POST -H "Content-Type: application/json" --data "$payload" "$SLACK_WEBHOOK_URL"
          else
            echo "Skipping Slack: success and ${MS}ms <= ${LAT_WARN}ms"
          fi
