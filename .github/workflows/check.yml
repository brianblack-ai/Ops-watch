name: uptime-check
on:
  schedule:
    - cron: "*/5 * * * *"   # every 5 minutes
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Test Slack from Actions
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          [ -z "$SLACK_WEBHOOK_URL" ] && echo "No SLACK_WEBHOOK_URL set" && exit 1
          curl -s -X POST -H 'Content-Type: application/json' \
            --data '{"text":"ðŸ”¬ Actions test: hello from *ops-watch*"}' \
            "$SLACK_WEBHOOK_URL" >/dev/null || true

      - name: Check endpoints and alert Slack on failure
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          PIPE: https://lead-engine-lilac.vercel.app/api/health
        run: |
          set -e
          fail=0
          for url in "$PIPE"; do
            code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 12 "$url" || true)
            echo "$url -> $code"
            if [ "$code" != "200" ]; then
              fail=1
              if [ -n "$SLACK_WEBHOOK_URL" ]; then
                curl -s -X POST -H 'Content-Type: application/json' \
                  --data "{\"text\":\"âŒ Uptime check failed: $url â†’ $code\"}" \
                  "$SLACK_WEBHOOK_URL" >/dev/null || true
              fi
            fi
          done
          exit $fail

